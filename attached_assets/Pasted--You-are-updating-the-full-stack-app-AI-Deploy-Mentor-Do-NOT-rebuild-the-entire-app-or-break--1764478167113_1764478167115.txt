
You are updating the full-stack app **AI Deploy Mentor**.
Do NOT rebuild the entire app or break existing flows.

Your task now:
Add an **Automatic Pull Request (Auto-PR)** system for internal project code.

The goal:
Whenever normalization or auto-fix modifies the project files,
AI Deploy Mentor should automatically create a PR-like record showing:
- what changed
- which files were added/removed/modified
- before/after diffs
- timestamp
- status

This does NOT require GitHub or external Git hosting.
Auto-PRs are stored inside our own database and file system.

-------------------------------------------------------
1. Database changes (pull_requests table)
-------------------------------------------------------

Create a new table: `pull_requests`

Fields:
- id (UUID)
- project_id (FK to projects table)
- pr_number (integer, auto-increment per project)
- title (string)
- description (TEXT)
- created_at (timestamp)
- status ("open" | "merged" | "closed")

- diff_json (JSON)  
  // structured diff: list of objects:
  // { file: "path/file.js", change: "modified|added|removed", before: "...", after: "..." }

- patch_folder_path (string)  
  // folder containing the proposed new version of the project

Also update the `projects` table with optional:
- last_pr_number (integer)

-------------------------------------------------------
2. Create PR service
-------------------------------------------------------

Create new file:
`services/pullRequestService.js`

Export:

```js
async function createAutoPullRequest(project, normalizedFolderPath, updatedFolderPath, actionsLog) { ... }
async function mergePullRequest(prId) { ... }
async function closePullRequest(prId) { ... }
module.exports = { createAutoPullRequest, mergePullRequest, closePullRequest };
````

### Purpose of createAutoPullRequest:

Inputs:

* `project` — DB project record
* `normalizedFolderPath` — the folder BEFORE auto-fix/normalization
* `updatedFolderPath` — the folder AFTER auto-fix/normalization
* `actionsLog` — array of human-readable actions already generated by normalizer or auto-fix

Steps:

1. Generate new PR number:

   * prNumber = project.last_pr_number + 1 (or 1 if null)

2. Compare normalizedFolderPath and updatedFolderPath:

   * Recursively list files in both folders.
   * For each file path:
     a) If exists only in updated → change = "added"
     b) If exists only in old → change = "removed"
     c) If exists in both:

     * Read file contents
     * If different → change = "modified"
     * If identical → skip
   * For modified files, include:

     * before: file content from normalizedFolderPath
     * after: file content from updatedFolderPath

3. Build `diff_json` array of structured diffs.

4. Create a PR record in DB:

   * project_id = project.id
   * pr_number = prNumber
   * title = "Auto-Fix Update (PR #" + prNumber + ")"
   * description = join(actionsLog, "\n")
   * diff_json = diff array
   * patch_folder_path = updatedFolderPath
   * status = "open"

5. Update `project.last_pr_number`.

6. Return the PR object.

### mergePullRequest(prId):

* Retrieve PR.
* For each file in `patch_folder_path`:

  * Apply updated versions into the normalized folder.
* Remove/overwrite old files according to diff_json.
* Set PR.status = "merged".
* Update project.modified_at.

### closePullRequest(prId):

* Simply set status = "closed" (no changes applied).

---

3. Integrate PR creation into normalization + auto-fix flows

---

After normalization or auto-fix produces a new folder with updated files:

* Before writing changes back to normalized_folder_path:

  * call:

```js
const { createAutoPullRequest } = require('./pullRequestService');

await createAutoPullRequest(
  project,
  project.normalized_folder_path,
  tempUpdatedFolderPath,
  actionsLog  // list of what was changed
);
```

Then:

* Do NOT overwrite anything yet.
* Wait for explicit user merge action OR enable auto-merge for first version.

For MVP:

* Auto-merge automatically right after PR creation.
* But still store the PR in DB for transparency.

---

4. Backend API

---

Create new routes file: `routes/pullRequests.js`

Add endpoints:

### GET /api/projects/:projectId/prs

Return list of PRs for the project.

### GET /api/prs/:prId

Return PR details, diff_json, and metadata.

### POST /api/prs/:prId/merge

Call mergePullRequest(prId) → return updated project.

### POST /api/prs/:prId/close

Call closePullRequest(prId).

---

5. Frontend changes

---

In project detail panel:

* Add a section: **"Code Pull Requests"**

  * Show list of PRs:

    * PR #number
    * created_at
    * status
    * title

* When selecting a PR:

  * Show:

    * Title
    * Description (actions log)
    * Status
    * A diff viewer (simple list):

      * file path
      * change type: added/removed/modified
      * before → after (for modified)

* Buttons:

  * "Merge PR" (if status === "open")
  * "Close PR" (if status === "open")

If auto-merge is active:

* UI still displays the PR as “merged automatically”.

---

6. Constraints

---

* DO NOT integrate external GitHub API.
* PR logic must be fully internal to the system.
* Ensure file operations do NOT delete the original uploaded ZIP.
* Keep diffs readable and limited to text files.
* Binary files should appear as “binary changed”.
* System must not crash if folder structures differ dramatically.
* Make sure normalization + auto-fix call PR creation BEFORE applying changes, unless auto-merge is enabled.
* Keep everything inside `/tmp` and `/normalized` safely.

---

When complete, I should be able to:

* Upload a messy project,
* Normalize/auto-fix it,
* See an internal PR showing all changes,
* Merge it (or let auto-merge),
* And keep a clean audit trail of modifications.

 
